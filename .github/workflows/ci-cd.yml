name: CI/CD Pipeline

on:
  pull_request:
    branches: main
  push:
    branches: main
  workflow_dispatch:

jobs:
  linter:
    name: Run linter
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring exif pcntl bcmath gd
          coverage: none
          
      - name: Validate composer files
        run: |
          cd app
          composer validate --strict
        
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: |
          cd app
          composer install --prefer-dist --no-progress
        
      - name: Run PHPStan
        run: |
          cd app
          vendor/bin/phpstan analyse src --memory-limit=2G

  tests:
    name: Run tests
    runs-on: ubuntu-24.04
    needs: linter
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring exif pcntl bcmath gd
          coverage: xdebug
          
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: |
          cd app
          composer install --prefer-dist --no-progress
        
      - name: Run PHPUnit tests with coverage
        run: |
          cd app
          vendor/bin/phpunit --coverage-text --coverage-filter=src --coverage-clover=coverage.xml tests
        
      - name: Check code coverage threshold
        run: |
          cd app
          cat coverage.xml
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÑ‚Ñ€Ð¾Ðº Ð¸Ð· XML Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
          COVERAGE=$(grep -o 'lines-covered="[0-9]*"' coverage.xml | grep -o '[0-9]*' | head -1)
          TOTAL=$(grep -o 'lines-valid="[0-9]*"' coverage.xml | grep -o '[0-9]*' | head -1)
          
          if [ -z "$COVERAGE" ] || [ -z "$TOTAL" ]; then
            echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÐºÐ¾Ð´Ð°"
            exit 1
          fi
          
          PERCENTAGE=$((COVERAGE * 100 / TOTAL))
          echo "ðŸ“Š ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð°: $COVERAGE/$TOTAL ÑÑ‚Ñ€Ð¾Ðº ($PERCENTAGE%)"
          
          if [ $PERCENTAGE -lt 60 ]; then
            echo "âŒ ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° ($PERCENTAGE%) Ð¼ÐµÐ½ÑŒÑˆÐµ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ñ€Ð¾Ð³Ð° (60%)"
            exit 1
          else
            echo "âœ… ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° ($PERCENTAGE%) ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼ (>=60%)"
          fi
        
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: app/coverage.xml
          retention-days: 30
        
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-24.04
    needs: [linter, tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts  
          
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /opt/blog && git pull
            cd /opt/blog && \ 
            docker compose up -d && \
            docker compose exec --user www-data blog-app bash -c "cd /opt/app && composer install"
          EOF 